openapi: 3.0.0
info:
  title: Sistema de Ventas API
  description: |
    Documentación de la API completa para la gestión de un **Sistema de Ventas**,
    construida con Flask y PostgreSQL.

    **Endpoints Principales (CRUD):**
    * Rol, Persona, Usuario, Distribuidor, Producto, Documento, Cliente.

    **Endpoints de Transacción/Reporte:**
    * Movimiento (Encabezado y detalle de Kardex)
    * Kardex (Reporte general)
  version: 1.0.0
servers:
  - url: http://localhost:5000/api
    description: Servidor de desarrollo local

tags:
  - name: Autenticacion
  - name: Rol
  - name: Persona
  - name: Usuario
  - name: Distribuidor
  - name: Producto
  - name: Documento
  - name: Movimiento (Transacciones)
  - name: Cliente
  - name: Kardex (Detalles/Reporte)

paths:
  # ============================================
  # AUTENTICACION
  # ============================================
  /auth/login:
    post:
      summary: Iniciar Sesión de Usuario
      tags:
        - Autenticacion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
              required:
                - username
                - password
      responses:
        '200':
          description: Inicio de sesión exitoso, retorna token
        '401':
          description: Credenciales inválidas

  # ============================================
  # ROL
  # ============================================
  /rol:
    get:
      summary: Obtener lista de roles
      tags:
        - Rol
      responses:
        '200':
          description: Lista de roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Rol'
    post:
      summary: Crear un nuevo rol
      tags:
        - Rol
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolInput'
      responses:
        '201':
          description: Rol creado exitosamente
  /rol/{id_rol}:
    parameters:
      - name: id_rol
        in: path
        required: true
        schema:
          type: integer
          description: ID del rol
    get:
      summary: Obtener rol por ID
      tags:
        - Rol
      responses:
        '200':
          description: Detalles del rol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rol'
    put:
      summary: Actualizar rol existente
      tags:
        - Rol
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolInput'
      responses:
        '200':
          description: Rol actualizado
    delete:
      summary: Eliminar un rol por ID
      tags:
        - Rol
      responses:
        '204':
          description: Rol eliminado

  # ============================================
  # PERSONA
  # ============================================
  /persona:
    get:
      summary: Obtener lista de personas
      tags:
        - Persona
      responses:
        '200':
          description: Lista de personas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Persona'
    post:
      summary: Crear una nueva persona
      tags:
        - Persona
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonaInput'
      responses:
        '201':
          description: Persona creada exitosamente

  /persona/{id_persona}:
    parameters:
      - name: id_persona
        in: path
        required: true
        schema:
          type: integer
          description: ID de la persona
    get:
      summary: Obtener persona por ID
      tags:
        - Persona
      responses:
        '200':
          description: Detalles de la persona
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Persona'
    put:
      summary: Actualizar persona
      tags:
        - Persona
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonaInput'
      responses:
        '200':
          description: Persona actualizada
    delete:
      summary: Eliminar una persona
      tags:
        - Persona
      responses:
        '204':
          description: Persona eliminada

  # ============================================
  # USUARIO
  # ============================================
  /usuario:
    get:
      summary: Obtener lista de usuarios
      tags:
        - Usuario
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Usuario'
    post:
      summary: Crear un nuevo usuario
      tags:
        - Usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UsuarioCreate'
      responses:
        '201':
          description: Usuario creado exitosamente

  /usuario/{id_usuario}:
    parameters:
      - name: id_usuario
        in: path
        required: true
        schema:
          type: integer
          description: ID del usuario (coincide con id_persona)
    get:
      summary: Obtener usuario por ID
      tags:
        - Usuario
      responses:
        '200':
          description: Detalles del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Usuario'
    put:
      summary: Actualizar usuario
      tags:
        - Usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UsuarioUpdate'
      responses:
        '200':
          description: Usuario actualizado
    delete:
      summary: Eliminar un usuario
      tags:
        - Usuario
      responses:
        '204':
          description: Usuario eliminado

  # ============================================
  # DISTRIBUIDOR
  # ============================================
  /distribuidor:
    get:
      summary: Obtener lista de distribuidores
      tags:
        - Distribuidor
      responses:
        '200':
          description: Lista de distribuidores
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Distribuidor'
    post:
      summary: Crear un nuevo distribuidor
      tags:
        - Distribuidor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DistribuidorInput'
      responses:
        '201':
          description: Distribuidor creado exitosamente

  /distribuidor/{id_distribuidor}:
    parameters:
      - name: id_distribuidor
        in: path
        required: true
        schema:
          type: integer
          description: ID del distribuidor (coincide con id_persona)
    get:
      summary: Obtener distribuidor por ID
      tags:
        - Distribuidor
      responses:
        '200':
          description: Detalles del distribuidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Distribuidor'
    put:
      summary: Actualizar distribuidor
      tags:
        - Distribuidor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DistribuidorInput'
      responses:
        '200':
          description: Distribuidor actualizado
    delete:
      summary: Eliminar un distribuidor
      tags:
        - Distribuidor
      responses:
        '204':
          description: Distribuidor eliminado

  # ============================================
  # PRODUCTO
  # ============================================
  /producto:
    get:
      summary: Obtener lista de productos
      tags:
        - Producto
      responses:
        '200':
          description: Lista de productos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Producto'
    post:
      summary: Crear un nuevo producto
      tags:
        - Producto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoInput'
      responses:
        '201':
          description: Producto creado exitosamente

  /producto/{id_producto}:
    parameters:
      - name: id_producto
        in: path
        required: true
        schema:
          type: integer
          description: ID del producto
    get:
      summary: Obtener producto por ID
      tags:
        - Producto
      responses:
        '200':
          description: Detalles del producto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Producto'
    put:
      summary: Actualizar producto
      tags:
        - Producto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductoInput'
      responses:
        '200':
          description: Producto actualizado
    delete:
      summary: Eliminar un producto
      tags:
        - Producto
      responses:
        '204':
          description: Producto eliminado

  # ============================================
  # DOCUMENTO
  # ============================================
  /documento:
    get:
      summary: Obtener lista de documentos
      tags:
        - Documento
      responses:
        '200':
          description: Lista de documentos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Documento'
    post:
      summary: Crear un nuevo documento
      tags:
        - Documento
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentoInput'
      responses:
        '201':
          description: Documento creado exitosamente

  /documento/{id_documento}:
    parameters:
      - name: id_documento
        in: path
        required: true
        schema:
          type: integer
          description: ID del documento
    get:
      summary: Obtener documento por ID
      tags:
        - Documento
      responses:
        '200':
          description: Detalles del documento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Documento'
    put:
      summary: Actualizar documento
      tags:
        - Documento
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentoInput'
      responses:
        '200':
          description: Documento actualizado
    delete:
      summary: Eliminar un documento
      tags:
        - Documento
      responses:
        '204':
          description: Documento eliminado

  # ============================================
  # MOVIMIENTO
  # ============================================
  /movimiento:
    get:
      summary: Obtener lista de movimientos
      tags:
        - Movimiento (Transacciones)
      responses:
        '200':
          description: Lista de movimientos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Movimiento'
    post:
      summary: Crear un nuevo movimiento (Transacción)
      tags:
        - Movimiento (Transacciones)
      description: Crea un nuevo movimiento y sus items de kardex asociados.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MovimientoFullInput'
      responses:
        '201':
          description: Movimiento y sus items creados exitosamente

  /movimiento/{id_movimiento}:
    parameters:
      - name: id_movimiento
        in: path
        required: true
        schema:
          type: integer
          description: ID del movimiento
    get:
      summary: Obtener movimiento por ID (incluyendo items de Kardex)
      tags:
        - Movimiento (Transacciones)
      responses:
        '200':
          description: Detalles del movimiento y sus items de kardex
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MovimientoFull'

  # ============================================
  # CLIENTE
  # ============================================
  /cliente:
    get:
      summary: Obtener lista de clientes
      tags:
        - Cliente
      responses:
        '200':
          description: Lista de clientes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Cliente'
    post:
      summary: Crear un nuevo cliente
      tags:
        - Cliente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClienteInput'
      responses:
        '201':
          description: Cliente creado exitosamente

  /cliente/{id_cliente}:
    parameters:
      - name: id_cliente
        in: path
        required: true
        schema:
          type: integer
          description: ID del cliente (coincide con id_persona)
    get:
      summary: Obtener cliente por ID
      tags:
        - Cliente
      responses:
        '200':
          description: Detalles del cliente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cliente'
    put:
      summary: Actualizar cliente
      tags:
        - Cliente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClienteInput'
      responses:
        '200':
          description: Cliente actualizado
    delete:
      summary: Eliminar un cliente
      tags:
        - Cliente
      responses:
        '204':
          description: Cliente eliminado

  # ============================================
  # KARDEX (Reporte)
  # ============================================
  /kardex:
    get:
      summary: Obtener registro general del kardex
      tags:
        - Kardex (Detalles/Reporte)
      description: Permite obtener todos los registros del kardex, idealmente con filtros de producto o fecha.
      responses:
        '200':
          description: Lista de registros del kardex
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Kardex'

components:
  schemas:
    Rol:
      type: object
      description: Modelo de Rol.
      properties:
        id_rol:
          type: integer
          description: ID único del rol.
          readOnly: true
        nombre:
          type: string
          description: Nombre descriptivo del rol.
      required:
        - id_rol
        - nombre
    RolInput:
      type: object
      description: Datos necesarios para crear o actualizar un Rol.
      properties:
        nombre:
          type: string
          description: Nombre descriptivo del rol.
      required:
        - nombre

    Persona:
      type: object
      description: Modelo de Persona (base para Usuario, Distribuidor y Cliente).
      properties:
        id_persona:
          type: integer
          description: ID único de la persona.
          readOnly: true
        nombre:
          type: string
        primer_apellido:
          type: string
        segundo_apellido:
          type: string
        numero_ci:
          type: integer
        complemento_ci:
          type: string
        correo:
          type: string
          format: email
        telefono:
          type: string
        direccion:
          type: string
      required:
        - nombre
        - numero_ci
        - correo
    PersonaInput:
      type: object
      description: Datos necesarios para crear o actualizar una Persona (sin el ID).
      properties:
        nombre:
          type: string
        primer_apellido:
          type: string
        segundo_apellido:
          type: string
        numero_ci:
          type: integer
        complemento_ci:
          type: string
        correo:
          type: string
          format: email
        telefono:
          type: string
        direccion:
          type: string
      required:
        - nombre
        - numero_ci
        - correo

    Usuario:
      type: object
      description: Modelo de Usuario (Vista completa).
      properties:
        id_usuario:
          type: integer
          description: ID del usuario (FK a Persona).
          readOnly: true
        username:
          type: string
        id_rol:
          type: integer
        nombre:
          type: string
        primer_apellido:
          type: string
        correo:
          type: string
      required:
        - id_usuario
        - username
        - id_rol
    UsuarioCreate:
      type: object
      description: Datos necesarios para crear un nuevo usuario.
      properties:
        id_persona:
          type: integer
          description: ID de una Persona ya existente o a crear.
        username:
          type: string
        password:
          type: string
          format: password
          writeOnly: true
        id_rol:
          type: integer
      required:
        - id_persona
        - username
        - password
        - id_rol
    UsuarioUpdate:
      type: object
      description: Datos para actualizar un usuario.
      properties:
        username:
          type: string
        password:
          type: string
          format: password
          writeOnly: true
        id_rol:
          type: integer

    Distribuidor:
      type: object
      description: Modelo de Distribuidor (Vista completa).
      properties:
        id_distribuidor:
          type: integer
          description: ID del distribuidor (FK a Persona).
          readOnly: true
        empresa:
          type: string
          description: Nombre de la empresa distribuidora (Único).
        nombre:
          type: string
        correo:
          type: string
      required:
        - id_distribuidor
        - empresa
    DistribuidorInput:
      type: object
      description: Datos para crear un distribuidor.
      properties:
        id_persona:
          type: integer
          description: ID de una Persona ya existente.
        empresa:
          type: string
      required:
        - id_persona
        - empresa

    Producto:
      type: object
      description: Modelo de Producto.
      properties:
        id_producto:
          type: integer
          description: ID único del producto.
          readOnly: true
        codigo:
          type: string
          description: Código del producto (Único).
        nombre:
          type: string
        descripcion:
          type: string
        unidad:
          type: string
          description: Unidad de medida (ej. 'Kg', 'Lt', 'Unidad').
        precio_base:
          type: number
          format: float
          description: Precio base de venta.
        id_distribuidor:
          type: integer
          description: ID del distribuidor (FK a Distribuidor).
      required:
        - id_producto
        - codigo
        - nombre
        - precio_base
        - id_distribuidor
    ProductoInput:
      type: object
      description: Datos para crear/actualizar un producto.
      properties:
        codigo:
          type: string
        nombre:
          type: string
        descripcion:
          type: string
        unidad:
          type: string
        precio_base:
          type: number
          format: float
        id_distribuidor:
          type: integer
      required:
        - codigo
        - nombre
        - precio_base
        - id_distribuidor

    Documento:
      type: object
      description: Modelo de Documento (ej. Factura, Nota de Venta).
      properties:
        id_documento:
          type: integer
          description: ID único.
          readOnly: true
        nombre:
          type: string
        tipo:
          type: string
          maxLength: 1
          description: Tipo de documento (ej. 'F' para Factura, 'N' para Nota).
          enum: [F, N, R, O]
      required:
        - id_documento
        - nombre
        - tipo
    DocumentoInput:
      type: object
      description: Datos para crear/actualizar un documento.
      properties:
        nombre:
          type: string
        tipo:
          type: string
          maxLength: 1
      required:
        - nombre
        - tipo

    Cliente:
      type: object
      description: Modelo de Cliente (Vista completa).
      properties:
        id_cliente:
          type: integer
          description: ID del cliente (FK a Persona).
          readOnly: true
        tipo:
          type: string
          maxLength: 1
          description: Tipo de cliente ('P' para Persona, 'J' para Jurídica).
          enum: [P, J]
        nombre:
          type: string
        correo:
          type: string
      required:
        - id_cliente
        - tipo
    ClienteInput:
      type: object
      description: Datos para crear un cliente.
      properties:
        id_persona:
          type: integer
          description: ID de una Persona ya existente.
        tipo:
          type: string
          maxLength: 1
          enum: [P, J]
      required:
        - id_persona
        - tipo

    Kardex:
      type: object
      description: Detalle de un producto en un movimiento (Salida de la API).
      properties:
        id_movimiento:
          type: integer
          description: ID del movimiento al que pertenece.
          readOnly: true
        id_producto:
          type: integer
          description: ID del producto involucrado.
          readOnly: true
        cantidad:
          type: number
          format: float
        unitario:
          type: number
          format: float
        subtotal:
          type: number
          format: float
      required:
        - id_movimiento
        - id_producto
        - cantidad
        - unitario
        - subtotal
    KardexInput:
      type: object
      description: Datos de un item de kardex para incluir en la creación de un Movimiento.
      properties:
        id_producto:
          type: integer
        cantidad:
          type: number
          format: float
        unitario:
          type: number
          format: float
      required:
        - id_producto
        - cantidad
        - unitario

    Movimiento:
      type: object
      description: Encabezado de un Movimiento.
      properties:
        id_movimiento:
          type: integer
          description: ID único.
          readOnly: true
        tipo:
          type: string
          maxLength: 1
          description: Tipo de movimiento ('E' para Entrada, 'S' para Salida).
          enum: [E, S]
        fecha:
          type: string
          format: date-time
        glosa:
          type: string
        observacion:
          type: string
        id_elaborador:
          type: integer
          description: ID del usuario que elabora el movimiento (FK a Usuario).
        id_cliente:
          type: integer
          description: ID del cliente involucrado (FK a Cliente).
        id_documento:
          type: integer
          description: ID del documento asociado (FK a Documento).
      required:
        - tipo
        - fecha
        - id_elaborador

    MovimientoFull:
      type: object
      description: Representación completa de un Movimiento (Encabezado + Detalles de Kardex).
      allOf:
        - $ref: '#/components/schemas/Movimiento'
        - properties:
            kardex_items:
              type: array
              description: Lista de los productos involucrados en este movimiento con todos sus detalles.
              items:
                $ref: '#/components/schemas/Kardex'
          required:
            - kardex_items

    MovimientoFullInput:
      type: object
      description: Esquema para crear un Movimiento completo.
      allOf:
        - $ref: '#/components/schemas/Movimiento'
        - properties:
            id_movimiento:
              type: integer
              readOnly: false
            kardex_items:
              type: array
              description: Lista de los productos y cantidades a incluir en el movimiento.
              items:
                $ref: '#/components/schemas/KardexInput'
          required:
            - kardex_items