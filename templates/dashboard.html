<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <h3 id="titulo"></h3>
    <p id="descripcion"></p>
    <button class="btn btn-secondary mb-4" onclick="cerrarSesion()">Cerrar sesión</button>

    <div id="opciones" class="mb-3"></div>
    <div id="contenido"></div>
</div>

<script>
const API_URL = "http://127.0.0.1:5000";
const usuario = JSON.parse(localStorage.getItem('usuario'));

if (!usuario) {
    window.location.href = '/';
}

document.getElementById('titulo').innerText = `Bienvenido, ${usuario.username}`;
document.getElementById('descripcion').innerText =
    usuario.rol === 'Administrador'
        ? 'Tienes acceso completo al sistema (Usuarios, Productos, Distribuidores, Documentos, Movimientos, Kardex)'
        : usuario.rol === 'Cajero'
            ? 'Puedes registrar ventas y ver productos disponibles'
            : 'Acceso limitado al catálogo';

function cerrarSesion() {
    localStorage.removeItem('usuario');
    window.location.href = '/';
}

// ===== Opciones según rol =====
const opcionesDiv = document.getElementById('opciones');
if (usuario.rol === 'Administrador') {
    opcionesDiv.innerHTML = `
        <button class="btn btn-primary me-2 mb-2" onclick="mostrarDistribuidores()">Distribuidores</button>
        <button class="btn btn-success me-2 mb-2" onclick="mostrarProductos()">Productos</button>
        <button class="btn btn-info me-2 mb-2" onclick="mostrarDocumentos()">Documentos</button>
        <button class="btn btn-warning me-2 mb-2" onclick="mostrarMovimientos()">Movimientos</button>
        <button class="btn btn-dark mb-2" onclick="mostrarKardex()">Kardex</button>
    `;
} else if (usuario.rol === 'Cajero') {
    opcionesDiv.innerHTML = `
        <button class="btn btn-success me-2 mb-2" onclick="mostrarProductos()">Productos</button>
        <button class="btn btn-info mb-2" onclick="mostrarDocumentos()">Documentos</button>
    `;
}

// =====================
// DISTRIBUIDORES
// =====================
async function mostrarDistribuidores() {
    const res = await axios.get(`${API_URL}/distribuidores`);
    const data = res.data;
    let html = `<h4>Distribuidores</h4>
        <button class="btn btn-primary mb-2" onclick="agregarDistribuidorForm()">➕ Nuevo Distribuidor</button>
        <table class="table table-bordered">
            <thead><tr>
                <th>ID</th><th>NIT</th><th>Nombre</th><th>Contacto</th>
                <th>Teléfono</th><th>Dirección</th><th>Acción</th>
            </tr></thead><tbody>`;
    data.forEach(d => {
        html += `<tr>
            <td>${d.id_distribuidor}</td>
            <td><input value="${d.nit}" id="nit-${d.id_distribuidor}" class="form-control"></td>
            <td><input value="${d.nombre}" id="nombre-${d.id_distribuidor}" class="form-control"></td>
            <td><input value="${d.contacto || ''}" id="contacto-${d.id_distribuidor}" class="form-control"></td>
            <td><input value="${d.telefono || ''}" id="telefono-${d.id_distribuidor}" class="form-control"></td>
            <td><input value="${d.direccion || ''}" id="direccion-${d.id_distribuidor}" class="form-control"></td>
            <td>
                <button class="btn btn-success btn-sm mb-1" onclick="editarDistribuidor(${d.id_distribuidor})">Guardar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarDistribuidor(${d.id_distribuidor})">Eliminar</button>
            </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarDistribuidorForm() {
    const html = `
        <div class="card p-3 mb-3">
            <h5>Agregar Distribuidor</h5>
            <input id="nuevo-nit" class="form-control mb-2" placeholder="NIT">
            <input id="nuevo-nombre" class="form-control mb-2" placeholder="Nombre">
            <input id="nuevo-contacto" class="form-control mb-2" placeholder="Contacto">
            <input id="nuevo-telefono" class="form-control mb-2" placeholder="Teléfono">
            <input id="nuevo-direccion" class="form-control mb-2" placeholder="Dirección">
            <button class="btn btn-success" onclick="agregarDistribuidor()">Guardar</button>
        </div>
    `;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarDistribuidor() {
    const data = {
        nit: document.getElementById('nuevo-nit').value,
        nombre: document.getElementById('nuevo-nombre').value,
        contacto: document.getElementById('nuevo-contacto').value,
        telefono: document.getElementById('nuevo-telefono').value,
        direccion: document.getElementById('nuevo-direccion').value
    };
    await axios.post(`${API_URL}/distribuidores`, data);
    mostrarDistribuidores();
}

async function editarDistribuidor(id) {
    const data = {
        nit: document.getElementById(`nit-${id}`).value,
        nombre: document.getElementById(`nombre-${id}`).value,
        contacto: document.getElementById(`contacto-${id}`).value,
        telefono: document.getElementById(`telefono-${id}`).value,
        direccion: document.getElementById(`direccion-${id}`).value
    };
    await axios.put(`${API_URL}/distribuidores/${id}`, data);
    mostrarDistribuidores();
}

async function eliminarDistribuidor(id) {
    await axios.delete(`${API_URL}/distribuidores/${id}`);
    mostrarDistribuidores();
}

// =====================
// PRODUCTOS
// =====================
async function mostrarProductos() {
    const res = await axios.get(`${API_URL}/productos`);
    const data = res.data;
    let html = `<h4>Productos</h4>
        <button class="btn btn-primary mb-2" onclick="agregarProductoForm()">➕ Nuevo Producto</button>
        <table class="table table-bordered">
            <thead><tr>
                <th>ID</th><th>Código</th><th>Nombre</th><th>Descripción</th><th>Unidad</th><th>Distribuidor</th><th>Acción</th>
            </tr></thead><tbody>`;
    data.forEach(p => {
        html += `<tr>
            <td>${p.id_producto}</td>
            <td><input value="${p.codigo}" id="codigo-${p.id_producto}" class="form-control"></td>
            <td><input value="${p.nombre}" id="nombreP-${p.id_producto}" class="form-control"></td>
            <td><input value="${p.descripcion || ''}" id="descripcion-${p.id_producto}" class="form-control"></td>
            <td><input value="${p.unidad || ''}" id="unidad-${p.id_producto}" class="form-control"></td>
            <td>
                <input value="${p.distribuidor_nombre || ''}" class="form-control" disabled>
                <input type="hidden" value="${p.id_distribuidor}" id="id_distribuidor-${p.id_producto}">
            </td>
            <td>
                <button class="btn btn-success btn-sm mb-1" onclick="editarProducto(${p.id_producto})">Guardar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${p.id_producto})">Eliminar</button>
            </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarProductoForm() {
    const html = `
        <div class="card p-3 mb-3">
            <h5>Agregar Producto</h5>
            <input id="nuevo-codigo" class="form-control mb-2" placeholder="Código">
            <input id="nuevo-nombreP" class="form-control mb-2" placeholder="Nombre">
            <input id="nuevo-descripcion" class="form-control mb-2" placeholder="Descripción">
            <input id="nuevo-unidad" class="form-control mb-2" placeholder="Unidad">
            <input id="nuevo-id_distribuidor" class="form-control mb-2" placeholder="ID Distribuidor">
            <button class="btn btn-success" onclick="agregarProducto()">Guardar</button>
        </div>
    `;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarProducto() {
    const data = {
        codigo: document.getElementById('nuevo-codigo').value,
        nombre: document.getElementById('nuevo-nombreP').value,
        descripcion: document.getElementById('nuevo-descripcion').value,
        unidad: document.getElementById('nuevo-unidad').value,
        id_distribuidor: parseInt(document.getElementById('nuevo-id_distribuidor').value)
    };
    await axios.post(`${API_URL}/productos`, data);
    mostrarProductos();
}

async function editarProducto(id) {
    const data = {
        codigo: document.getElementById(`codigo-${id}`).value,
        nombre: document.getElementById(`nombreP-${id}`).value,
        descripcion: document.getElementById(`descripcion-${id}`).value,
        unidad: document.getElementById(`unidad-${id}`).value,
        id_distribuidor: parseInt(document.getElementById(`id_distribuidor-${id}`).value)
    };
    await axios.put(`${API_URL}/productos/${id}`, data);
    mostrarProductos();
}

async function eliminarProducto(id) {
    await axios.delete(`${API_URL}/productos/${id}`);
    mostrarProductos();
}

// =====================
// DOCUMENTOS
// =====================
async function mostrarDocumentos() {
    const res = await axios.get(`${API_URL}/documentos`);
    const data = res.data;
    let html = `<h4>Documentos</h4>
        <button class="btn btn-primary mb-2" onclick="agregarDocumentoForm()">➕ Nuevo Documento</button>
        <table class="table table-bordered">
            <thead><tr>
                <th>ID</th><th>Número</th><th>Fecha</th><th>Acción</th>
            </tr></thead><tbody>`;
    data.forEach(d => {
        html += `<tr>
            <td>${d.id_documento}</td>
            <td><input value="${d.numero}" id="numero-${d.id_documento}" class="form-control"></td>
            <td><input value="${d.fecha}" id="fecha-${d.id_documento}" class="form-control"></td>
            <td>
                <button class="btn btn-success btn-sm mb-1" onclick="editarDocumento(${d.id_documento})">Guardar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarDocumento(${d.id_documento})">Eliminar</button>
            </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarDocumentoForm() {
    const html = `
        <div class="card p-3 mb-3">
            <h5>Agregar Documento</h5>
            <input id="nuevo-numero" class="form-control mb-2" placeholder="Número">
            <input id="nuevo-fecha" class="form-control mb-2" placeholder="Fecha (YYYY-MM-DD)">
            <button class="btn btn-success" onclick="agregarDocumento()">Guardar</button>
        </div>
    `;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarDocumento() {
    const data = {
        numero: parseInt(document.getElementById('nuevo-numero').value),
        fecha: document.getElementById('nuevo-fecha').value
    };
    await axios.post(`${API_URL}/documentos`, data);
    mostrarDocumentos();
}

async function editarDocumento(id) {
    const data = {
        numero: parseInt(document.getElementById(`numero-${id}`).value),
        fecha: document.getElementById(`fecha-${id}`).value
    };
    await axios.put(`${API_URL}/documentos/${id}`, data);
    mostrarDocumentos();
}

async function eliminarDocumento(id) {
    await axios.delete(`${API_URL}/documentos/${id}`);
    mostrarDocumentos();
}

// =====================
// MOVIMIENTOS
// =====================
async function mostrarMovimientos() {
    const res = await axios.get(`${API_URL}/movimientos`);
    const data = res.data;
    let html = `<h4>Movimientos</h4>
        <button class="btn btn-primary mb-2" onclick="agregarMovimientoForm()">➕ Nuevo Movimiento</button>
        <table class="table table-bordered">
            <thead><tr>
                <th>ID</th><th>Tipo</th><th>Fecha</th><th>Glosa</th><th>Observación</th>
                <th>Elaborado por</th><th>Cliente</th><th>Documento</th><th>Acción</th>
            </tr></thead><tbody>`;
    data.forEach(m => {
        html += `<tr>
            <td>${m.id_movimiento}</td>
            <td><input value="${m.tipo}" id="tipo-${m.id_movimiento}" class="form-control"></td>
            <td><input value="${m.fecha}" id="fechaM-${m.id_movimiento}" class="form-control"></td>
            <td><input value="${m.glosa || ''}" id="glosa-${m.id_movimiento}" class="form-control"></td>
            <td><input value="${m.observacion || ''}" id="observacion-${m.id_movimiento}" class="form-control"></td>
            <td><input value="${m.elaborado_por || ''}" class="form-control" disabled></td>
            <td><input value="${m.cliente || ''}" class="form-control" disabled></td>
            <td><input value="${m.documento_numero || ''}" class="form-control" disabled></td>
            <td>
                <button class="btn btn-success btn-sm mb-1" onclick="editarMovimiento(${m.id_movimiento})">Guardar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarMovimiento(${m.id_movimiento})">Eliminar</button>
            </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarMovimientoForm() {
    const html = `
        <div class="card p-3 mb-3">
            <h5>Agregar Movimiento</h5>
            <input id="nuevo-tipo" class="form-control mb-2" placeholder="Tipo (I/S)">
            <input id="nuevo-fechaM" class="form-control mb-2" placeholder="Fecha (YYYY-MM-DD)">
            <input id="nuevo-glosa" class="form-control mb-2" placeholder="Glosa">
            <input id="nuevo-observacion" class="form-control mb-2" placeholder="Observación">
            <input id="nuevo-id_elaborador" class="form-control mb-2" placeholder="ID Usuario Elaborador">
            <input id="nuevo-id_cliente" class="form-control mb-2" placeholder="ID Cliente">
            <input id="nuevo-id_documento" class="form-control mb-2" placeholder="ID Documento">
            <button class="btn btn-success" onclick="agregarMovimiento()">Guardar</button>
        </div>
    `;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarMovimiento() {
    const data = {
        tipo: document.getElementById('nuevo-tipo').value,
        fecha: document.getElementById('nuevo-fechaM').value,
        glosa: document.getElementById('nuevo-glosa').value,
        observacion: document.getElementById('nuevo-observacion').value,
        id_elaborador: parseInt(document.getElementById('nuevo-id_elaborador').value),
        id_cliente: parseInt(document.getElementById('nuevo-id_cliente').value),
        id_documento: parseInt(document.getElementById('nuevo-id_documento').value)
    };
    await axios.post(`${API_URL}/movimientos`, data);
    mostrarMovimientos();
}

async function editarMovimiento(id) {
    const data = {
        tipo: document.getElementById(`tipo-${id}`).value,
        fecha: document.getElementById(`fechaM-${id}`).value,
        glosa: document.getElementById(`glosa-${id}`).value,
        observacion: document.getElementById(`observacion-${id}`).value
    };
    await axios.put(`${API_URL}/movimientos/${id}`, data);
    mostrarMovimientos();
}

async function eliminarMovimiento(id) {
    await axios.delete(`${API_URL}/movimientos/${id}`);
    mostrarMovimientos();
}

// =====================
// KARDEX
// =====================
async function mostrarKardex() {
    const res = await axios.get(`${API_URL}/kardex`);
    const data = res.data;
    let html = `<h4>Kardex</h4>
        <button class="btn btn-primary mb-2" onclick="agregarKardexForm()">➕ Nuevo Registro</button>
        <table class="table table-bordered">
            <thead><tr>
                <th>ID Movimiento</th><th>ID Producto</th><th>Producto</th><th>Tipo</th>
                <th>Fecha</th><th>Cantidad</th><th>Unitario</th><th>Subtotal</th><th>Acción</th>
            </tr></thead><tbody>`;
    data.forEach(k => {
        html += `<tr>
            <td>${k.id_movimiento}</td>
            <td>${k.id_producto}</td>
            <td>${k.producto}</td>
            <td>${k.tipo_movimiento}</td>
            <td>${k.fecha}</td>
            <td>${k.cantidad}</td>
            <td>${k.unitario}</td>
            <td>${k.suttotal}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarKardex(${k.id_movimiento}, ${k.id_producto})">Eliminar</button>
            </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarKardexForm() {
    const html = `
        <div class="card p-3 mb-3">
            <h5>Agregar Kardex</h5>
            <input id="nuevo-id_movimiento" class="form-control mb-2" placeholder="ID Movimiento">
            <input id="nuevo-id_producto" class="form-control mb-2" placeholder="ID Producto">
            <input id="nuevo-cantidad" class="form-control mb-2" placeholder="Cantidad">
            <input id="nuevo-unitario" class="form-control mb-2" placeholder="Precio Unitario">
            <input id="nuevo-suttotal" class="form-control mb-2" placeholder="Subtotal">
            <button class="btn btn-success" onclick="agregarKardex()">Guardar</button>
        </div>
    `;
    document.getElementById('contenido').innerHTML = html;
}

async function agregarKardex() {
    const data = {
        id_movimiento: parseInt(document.getElementById('nuevo-id_movimiento').value),
        id_producto: parseInt(document.getElementById('nuevo-id_producto').value),
        cantidad: parseFloat(document.getElementById('nuevo-cantidad').value),
        unitario: parseFloat(document.getElementById('nuevo-unitario').value),
        suttotal: parseFloat(document.getElementById('nuevo-suttotal').value)
    };
    await axios.post(`${API_URL}/kardex`, data);
    mostrarKardex();
}

async function eliminarKardex(id_movimiento, id_producto) {
    const data = { id_movimiento, id_producto };
    await axios.delete(`${API_URL}/kardex`, { data });
    mostrarKardex();
}

</script>
</body>
</html>
